# üéØ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

## –ü—Ä–æ–±–ª–µ–º–∞

**–°—Ç–∞—Ä–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è):**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ ‚Üí PostgreSQL (—Å—Ç–∞—Ç—É—Å: PENDING)
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç 1 ‚Üí –ø–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å (–º–æ–∂–µ—Ç –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)
3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç 2 ‚Üí –ø–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å (–º–æ–∂–µ—Ç –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)
‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (inconsistent state)
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –û—à–∏–±–∫–∞ `Permission denied` –æ—Å—Ç–∞–≤–ª—è–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ PENDING –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤–∏–¥–µ–ª "–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", —Ö–æ—Ç—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Ö –æ—Ç–ø—Ä–∞–≤–ª—è–ª
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
- –ú—É—Å–æ—Ä –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

---

## –†–µ—à–µ–Ω–∏–µ: Redis Staging + –ê—Ç–æ–º–∞—Ä–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è

**–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ ‚Üí Redis (TTL 24—á)
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç 1 ‚Üí file_id –≤ Redis
3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç 2 ‚Üí file_id –≤ Redis
4. –í—Å–µ –≥–æ—Ç–æ–≤–æ? ‚Üí –ê—Ç–æ–º–∞—Ä–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:
   ‚úÖ –°–æ–∑–¥–∞—Ç—å User –≤ PostgreSQL
   ‚úÖ –°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã
   ‚úÖ –°–æ–∑–¥–∞—Ç—å –≤—Å–µ Documents
   ‚úÖ Commit (–µ—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí rollback –≤—Å–µ–≥–æ)
5. –û—á–∏—Å—Ç–∏—Ç—å Redis
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ PostgreSQL –≤—Å–µ–≥–¥–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π
- ‚úÖ –û—Ç–∫–∞—Ç –ø—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (TTL 24—á)
- ‚úÖ –ù–µ—Ç –º—É—Å–æ—Ä–∞ –≤ –ë–î

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. Redis Storage (`bot/utils/redis_storage.py`)
```python
registration:{telegram_id}:language = "ru"       # TTL: 24h
registration:{telegram_id}:data = {              # TTL: 24h
    "full_name": "...",
    "phone": "...",
    "username": "...",
    "email": "..."
}
registration:{telegram_id}:documents = {         # TTL: 24h
    "passport": "AgACAgIAAxkBAANE...",  # file_id –æ—Ç Telegram
    "selfie": "AgACAgIAAxkBAANJ..."
}
```

**–ú–µ—Ç–æ–¥—ã:**
- `set_language()`, `get_language()`
- `set_user_data()`, `get_user_data()`
- `set_document()`, `get_documents()`
- `is_registration_complete()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
- `clear_registration_data()` - –æ—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- `extend_ttl()` - –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏

### 2. Registration Service (`services/registration_service.py`)
**–ê—Ç–æ–º–∞—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**
```python
async with session.begin():  # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
    # 1. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = User(...)
    session.add(user)
    await session.flush()  # –ü–æ–ª—É—á–∏—Ç—å user.id
    
    # 2. –°–∫–∞—á–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –í–°–ï –¥–æ–∫—É–º–µ–Ω—Ç—ã
    for file_id in documents:
        file_path = await download_from_telegram(file_id)
        doc = Document(user_id=user.id, file_path=file_path)
        session.add(doc)
    
    # 3. Commit (–∏–ª–∏ rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ)
    await session.commit()
```

**–ü—Ä–∏ –æ—à–∏–±–∫–µ:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –£–¥–∞–ª–µ–Ω–∏–µ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –î–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ Redis
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É

### 3. Cleanup Service (`services/cleanup_service.py`)
**Background –∑–∞–¥–∞—á–∞ (–∫–∞–∂–¥—ã–π —á–∞—Å):**
- –ù–∞—Ö–æ–¥–∏—Ç —Ñ–∞–π–ª—ã –±–µ–∑ –∑–∞–ø–∏—Å–µ–π –≤ –ë–î (orphaned files)
- –£–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 48 —á–∞—Å–æ–≤
- –£–¥–∞–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤

---

## –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### –®–∞–≥ 1: –í—ã–±–æ—Ä —è–∑—ã–∫–∞
```
/start ‚Üí –í—ã–±–æ—Ä —è–∑—ã–∫–∞ ‚Üí Redis: language
```

### –®–∞–≥ 2: –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö
```
–ò–º—è ‚Üí –¢–µ–ª–µ—Ñ–æ–Ω ‚Üí Redis: user_data
```

### –®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```
–ü–∞—Å–ø–æ—Ä—Ç/–ü—Ä–∞–≤–∞ ‚Üí Redis: documents.passport
–°–µ–ª—Ñ–∏ ‚Üí Redis: documents.selfie
```

### –®–∞–≥ 4: –ê—Ç–æ–º–∞—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
```python
if all_documents_uploaded:
    try:
        async with transaction:
            user = create_user()
            for doc in documents:
                download_and_save(doc)
            commit()
        
        # –£—Å–ø–µ—Ö
        clear_redis()
        notify_user("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    except Exception:
        # –û—à–∏–±–∫–∞ - –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ Redis
        rollback()
        notify_user("–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ /start")
```

### –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
```
/start ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis ‚Üí –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ?
    ‚Üí –î–∞: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é?"
    ‚Üí –ù–µ—Ç: "–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é"
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
```bash
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å /start –±–æ—Ç—É
2. –í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫
3. –í–≤–µ—Å—Ç–∏ –∏–º—è
4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
5. –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Å–ø–æ—Ä—Ç
6. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–ª—Ñ–∏
7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ PostgreSQL:
   SELECT * FROM users WHERE telegram_id = YOUR_ID;
   SELECT * FROM documents WHERE user_id = (SELECT id FROM users WHERE telegram_id = YOUR_ID);
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –≤ –ë–î
- ‚úÖ –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ –§–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –Ω–∞ –¥–∏—Å–∫–µ
- ‚úÖ Redis –æ—á–∏—â–µ–Ω

### 2. –ü—Ä–µ—Ä–≤–∞–Ω–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
```bash
1. –ù–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é (/start)
2. –í–≤–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ
3. –ó–∞–≥—Ä—É–∑–∏—Ç—å –û–î–ò–ù –¥–æ–∫—É–º–µ–Ω—Ç
4. –ó–∞–∫—Ä—ã—Ç—å –±–æ—Ç–∞
5. –ß–µ—Ä–µ–∑ —á–∞—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å /start —Å–Ω–æ–≤–∞
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ë–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
- ‚úÖ –£–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Å–Ω–æ–≤–∞
- ‚úÖ –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è

### 3. –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
```bash
1. –ù–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
3. (–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É - –Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–∏—Å–∫)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PostgreSQL
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —Å–æ–∑–¥–∞–Ω –≤ –ë–î
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç—ã –ù–ï —Å–æ–∑–¥–∞–Ω—ã –≤ –ë–î
- ‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ Redis
- ‚úÖ –ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ /start

### 4. Cleanup –∑–∞–¥–∞—á–∞
```bash
# –°–æ–∑–¥–∞—Ç—å orphaned —Ñ–∞–π–ª
echo "test" > uploads/test_orphaned.jpg

# –ü–æ–¥–æ–∂–¥–∞—Ç—å 2 –¥–Ω—è –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å mtime
touch -t 202310011200 uploads/test_orphaned.jpg

# –ó–∞–ø—É—Å—Ç–∏—Ç—å cleanup –≤—Ä—É—á–Ω—É—é
python services/cleanup_service.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Orphaned —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã
- ‚úÖ –§–∞–π–ª—ã –∏–∑ –ë–î —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
```
‚úÖ Language saved to Redis: 123456 -> ru
‚úÖ User data saved to Redis: 123456 -> John Doe
‚úÖ Document file_id saved to Redis: 123456 -> passport
üéâ All documents collected! Starting atomic registration for 123456
‚úÖ User created: ID=1, Name=John Doe
üì• Downloading passport (file_id: AgACAgIAAxkBAANE...)
‚úÖ Document downloaded: passport -> 123456_passport_AgAC...jpg
‚úÖ Document saved: passport
‚úÖ Atomic registration completed for user 1
üßπ Redis data cleared for 123456
üéâ Registration complete for user 123456
```

### –õ–æ–≥–∏ cleanup
```
üßπ Starting cleanup of orphaned files (age > 48h)
üìä Files in database: 15
üóëÔ∏è  Deleted orphaned file: 123_passport_old.jpg (age: 3 days)
‚è≥ Kept recent orphaned file: 456_selfie_new.jpg (age: 1 hour)
üìä Cleanup statistics:
   Deleted: 1
   Kept: 2
   Errors: 0
```

---

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Å—Ç—Ä—è–ª–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ PENDING –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:

```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –£–¥–∞–ª–∏—Ç—å –∏–∑ –ë–î (–æ–Ω–∏ —Å–º–æ–≥—É—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ)
docker exec -it velo-postgres psql -U velo_user -d velo_bot -c "
DELETE FROM users WHERE status = 'PENDING' AND id NOT IN (SELECT DISTINCT user_id FROM documents);
"

# –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—É—Ç–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
docker exec -it velo-bot python3 scripts/fix_document_paths.py
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Redis TTL
```python
# bot/utils/redis_storage.py
REGISTRATION_TTL = 24 * 60 * 60  # 24 —á–∞—Å–∞
```

### Cleanup –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
```python
# main.py
cleanup_task = asyncio.create_task(
    run_periodic_cleanup(
        interval_hours=1,        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å
        max_file_age_hours=48    # –£–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 48 —á–∞—Å–æ–≤
    )
)
```

---

## FAQ

**Q: –ß—Ç–æ –µ—Å–ª–∏ Redis —É–ø–∞–¥–µ—Ç –≤–æ –≤—Ä–µ–º—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏?**  
A: –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–ø–∞–¥—É—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–Ω–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ. PostgreSQL –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —á–∏—Å—Ç—ã–º.

**Q: –ß—Ç–æ –µ—Å–ª–∏ —Ñ–∞–π–ª –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–π–º–µ—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏?**  
A: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–¥–æ–∂–¥–µ—Ç. –ü—Ä–∏ –æ—à–∏–±–∫–µ - rollback, —Ñ–∞–π–ª—ã —É–¥–∞–ª—è—Ç—Å—è, –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ Redis.

**Q: –ö–∞–∫ –¥–æ–ª–≥–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –≤ Redis?**  
A: 24 —á–∞—Å–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º –ø—Ä–∏ /start.

**Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑ Redis?**  
A: –ù–µ—Ç. Redis –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- Redis (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- PostgreSQL + asyncpg
- aiogram 3.x
- SQLAlchemy 2.x (async)

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ `bot/utils/redis_storage.py` - –Ω–æ–≤—ã–π
- ‚úÖ `services/registration_service.py` - –Ω–æ–≤—ã–π
- ‚úÖ `services/cleanup_service.py` - –Ω–æ–≤—ã–π
- ‚úÖ `bot/handlers/common/start.py` - –ø–µ—Ä–µ–ø–∏—Å–∞–Ω
- ‚úÖ `main.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ cleanup
- ‚úÖ `locales/ru/messages.json` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–≤–æ–¥—ã

---

## –ö–æ–º–º–∏—Ç

```bash
git add bot/utils/redis_storage.py
git add services/registration_service.py
git add services/cleanup_service.py
git add bot/handlers/common/start.py
git add main.py
git add locales/ru/messages.json
git add REGISTRATION_REFACTORING.md

git commit -m "–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: Redis staging + –∞—Ç–æ–º–∞—Ä–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω Redis staging –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (TTL 24—á)
- –ê—Ç–æ–º–∞—Ä–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: User + –≤—Å–µ Documents —Å–æ–∑–¥–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- Cleanup service –¥–ª—è orphaned —Ñ–∞–π–ª–æ–≤
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å PostgreSQL –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞

Fixes: Permission denied –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
Fixes: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –ë–î"
```

---

**–ê–≤—Ç–æ—Ä**: AI Assistant (–°–µ–Ω—å–æ—Ä —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–∂–∏–º üöÄ)  
**–î–∞—Ç–∞**: 2025-10-30

