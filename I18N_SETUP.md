# 🌐 Настройка мультиязычности (i18n)

## Установка

Библиотека `aiogram-i18n` уже добавлена в `requirements.txt` и настроена в проекте.

## Поддерживаемые языки

- 🇷🇺 **Русский** (ru) - по умолчанию
- 🇹🇯 **Таджикский** (tg)
- 🇺🇿 **Узбекский** (uz)

## Структура файлов

```
locales/
├── ru/
│   └── messages.json    # Русские переводы
├── tg/
│   └── messages.json    # Таджикские переводы
└── uz/
    └── messages.json    # Узбекские переводы
```

## Миграция базы данных

Перед первым запуском выполните SQL миграцию для добавления поля `language` в таблицу `users`:

```bash
# Через psql
psql -U your_user -d your_database -f init.sql/add_language_field.sql

# Или через docker
docker exec -i your_postgres_container psql -U your_user -d your_database < init.sql/add_language_field.sql
```

Альтернативно, можно запустить Python скрипт (если настроено виртуальное окружение):

```bash
python scripts/add_language_field.py
```

## Как это работает

### 1. При регистрации

Новым пользователям предлагается выбрать язык перед началом регистрации:
- Отображается меню с тремя языками
- Выбранный язык сохраняется в базу данных
- Все последующие сообщения отображаются на выбранном языке

### 2. Изменение языка

Существующие пользователи могут изменить язык через профиль:
1. Перейти в "👤 Профиль"
2. Нажать "🌐 Изменить язык"
3. Выбрать новый язык

### 3. Автоматическое определение языка

При каждом запросе система автоматически:
1. Получает Telegram ID пользователя
2. Загружает его язык из базы данных
3. Применяет соответствующие переводы

## Добавление новых переводов

### Структура JSON файла

```json
{
  "language": {
    "name": "Русский 🇷🇺",
    "code": "ru"
  },
  
  "common": {
    "back": "◀️ Назад",
    "cancel": "❌ Отмена"
  },
  
  "start": {
    "welcome_back": "👋 Добро пожаловать обратно, {name}!"
  }
}
```

### Добавление нового перевода

1. Откройте соответствующий `messages.json`
2. Добавьте новый ключ в нужную секцию
3. Сохраните файл
4. Перезапустите бота

### Использование в коде

#### Вариант 1: Прямой доступ к переводам (текущий подход)

```python
# Получаем язык пользователя из БД
user_language = user.language  # "ru", "tg" или "uz"

# Создаем словарь с переводами
messages = {
    "ru": "Добро пожаловать!",
    "tg": "Хуш омадед!",
    "uz": "Xush kelibsiz!"
}

# Отправляем сообщение на нужном языке
await message.answer(messages.get(user_language, messages["ru"]))
```

#### Вариант 2: Через aiogram-i18n (для будущего расширения)

```python
from aiogram_i18n import I18nContext

async def some_handler(message: Message, i18n: I18nContext):
    # Автоматически использует язык пользователя
    await message.answer(i18n.get("start-welcome_back", name=user.full_name))
```

## Текущий статус

✅ **Реализовано:**
- Добавление поля `language` в модель User
- Создание JSON файлов с переводами для 3 языков
- Выбор языка при регистрации
- Изменение языка через профиль
- Middleware для автоматического определения языка
- Отображение текущего языка в профиле

📝 **Следующие шаги:**
1. Запустить миграцию БД для добавления поля `language`
2. Протестировать регистрацию с выбором языка
3. Постепенно переводить все сообщения на использование JSON файлов
4. Перевести существующие сообщения на таджикский и узбекский

## Полезные функции

### `change_user_language(telegram_id, new_language)`

Изменяет язык пользователя в базе данных.

```python
from bot.utils.i18n import change_user_language

success = await change_user_language(telegram_id=123456789, new_language="tg")
```

### `get_language_name(language_code)`

Возвращает название языка с флагом.

```python
from bot.utils.i18n import get_language_name

name = get_language_name("ru")  # "Русский 🇷🇺"
```

## Рекомендации

1. **Единообразие**: Используйте одинаковые ключи во всех языковых файлах
2. **Параметры**: Используйте `{parameter}` для динамических значений
3. **Тестирование**: Проверяйте переводы на всех языках
4. **Резервный язык**: Всегда указывайте русский как fallback

## Примеры использования

### Пример 1: Приветствие с именем

```python
messages = {
    "ru": f"Привет, {user.full_name}!",
    "tg": f"Салом, {user.full_name}!",
    "uz": f"Salom, {user.full_name}!"
}
await message.answer(messages.get(user.language, messages["ru"]))
```

### Пример 2: Статус документов

```python
status_messages = {
    "ru": "⏳ Ваши документы на проверке",
    "tg": "⏳ Ҳуҷҷатҳои шумо дар санҷиш",
    "uz": "⏳ Hujjatlaringiz tekshiruvda"
}
text = status_messages.get(user.language, status_messages["ru"])
```

## Поддержка

При возникновении проблем:
1. Проверьте наличие поля `language` в таблице `users`
2. Убедитесь, что JSON файлы валидны
3. Проверьте логи бота на наличие ошибок i18n
4. Убедитесь, что middleware настроен корректно в `main.py`

